# Stripe Webhook Integration Test Results

## Test Execution Summary

**Date:** 2026-01-16  
**Test Event:** `account.updated`  
**Webhook Endpoint:** `http://localhost:5000/api/webhooks/stripe`  
**Webhook Secret:** `whsec_1721cdb94f0a208109e8d7e75f0cb19be59e91e7d2e895db86b09357b4ce6580`

## Test Steps Completed

### ✅ 1. Environment Setup
- **Stripe CLI:** Installed and authenticated (v1.34.0)
- **Webhook Tunnel:** Running and forwarding to localhost:5000
- **Webhook Secret:** Updated in `api/.env`
- **API Server:** Running (Node.js processes detected)

### ✅ 2. Webhook Event Triggered
```bash
stripe trigger account.updated
```
**Result:** Event triggered successfully
```
Trigger succeeded! Check dashboard for event details.
```

### ✅ 3. Webhook Handler Improvements
Enhanced logging added to `api/_src/routes/webhooks.ts`:
- Logs account details (details_submitted, charges_enabled, payouts_enabled)
- Logs user lookup results
- Logs database update status
- Provides clear error messages for debugging

## Verification Steps

### 1. Check API Server Logs
Look for the following in your API server console:
```
[WEBHOOK] Account updated event received for account: acct_...
   Details submitted: true/false
   Charges enabled: true/false
   Payouts enabled: true/false
[WEBHOOK] Found user <user_id> (<email>) for account <account_id>
[WEBHOOK] Onboarding complete: true/false
✅ Updated Connect account status for user <user_id> - fully onboarded
```

**OR** if no matching account:
```
[WEBHOOK] No user found with stripeAccountId: acct_...
   This is normal for test events that don't match existing accounts
```

### 2. Verify Database Update
Run the following SQL query:
```sql
SELECT 
    id,
    email,
    stripe_account_id,
    stripe_onboarding_complete,
    updated_at
FROM users
WHERE stripe_account_id IS NOT NULL
ORDER BY updated_at DESC
LIMIT 10;
```

**Expected Result:**
- If a matching `stripe_account_id` exists in your database, `stripe_onboarding_complete` should be updated based on the account status
- `updated_at` timestamp should reflect the webhook processing time

### 3. Check Webhook Response
The webhook endpoint should return:
- **Status Code:** `200 OK`
- **Response Body:** `{"received": true}`

## Important Notes

### Test Events vs Real Events
⚠️ **Important:** Test events triggered by Stripe CLI (`stripe trigger`) use **fixture data** that may not match your actual database records.

- Test events have account IDs like `acct_test_...` that are generated by Stripe's test fixtures
- These IDs won't match real `stripe_account_id` values in your `users` table
- The webhook will still be **received and processed**, but no database update will occur if there's no matching account

### Testing with Real Accounts
To test with a real account:

1. **Create a test user with Stripe account:**
   - Use the venue dashboard to "Connect with Stripe"
   - Complete the onboarding flow
   - Note the `stripe_account_id` created

2. **Trigger account update via Stripe Dashboard:**
   - Go to: https://dashboard.stripe.com/test/connect/accounts
   - Find your test account
   - Make a change (e.g., update business details)
   - This will trigger a real `account.updated` event

3. **Or use Stripe API to update account:**
   ```bash
   stripe accounts update <account_id> --business-profile[name]="Test Update"
   ```

## Webhook Handler Logic

The `account.updated` webhook handler:

1. **Receives the event** and verifies the signature using `STRIPE_WEBHOOK_SECRET`
2. **Extracts account details:**
   - `account.id` (stripeAccountId)
   - `account.details_submitted`
   - `account.charges_enabled`
   - `account.payouts_enabled`
3. **Looks up user** by `stripeAccountId` in the `users` table
4. **Calculates completion status:**
   ```typescript
   const isComplete = account.details_submitted === true && 
                     account.charges_enabled === true && 
                     account.payouts_enabled === true;
   ```
5. **Updates database:**
   - Sets `stripe_onboarding_complete = true/false` in `users` table
   - Updates `updated_at` timestamp

## Database Schema

The webhook updates the **`users`** table (not `venues`):

```sql
users:
  - stripe_account_id (VARCHAR)
  - stripe_onboarding_complete (BOOLEAN, default: false)
  - updated_at (TIMESTAMP)
```

## Troubleshooting

### Webhook Not Received
- ✅ Check webhook tunnel is running: `stripe listen --forward-to localhost:5000/api/webhooks/stripe`
- ✅ Verify API server is running on port 5000
- ✅ Check `STRIPE_WEBHOOK_SECRET` matches the tunnel output

### Webhook Received but No Database Update
- ✅ Check API logs for user lookup results
- ✅ Verify a user exists with matching `stripe_account_id`
- ✅ Check database connection is working
- ✅ Review webhook handler logs for errors

### Signature Verification Failed
- ✅ Ensure `STRIPE_WEBHOOK_SECRET` in `api/.env` matches the tunnel secret
- ✅ Verify webhook endpoint uses `express.raw()` middleware
- ✅ Check that the signature header is being passed correctly

## Next Steps

1. **Monitor API logs** during real onboarding flows
2. **Test with actual user accounts** that have completed Stripe Connect onboarding
3. **Verify frontend updates** when `stripe_onboarding_complete` changes
4. **Test `identity.verification_session.verified`** event (requires actual verification flow)

## Related Files

- Webhook Handler: `api/_src/routes/webhooks.ts`
- Verification Script: `scripts/test-webhook-verification.ps1`
- SQL Queries: `scripts/verify-stripe-webhook.sql`
- Test Guide: `docs/STRIPE_ONBOARDING_TEST_GUIDE.md`
